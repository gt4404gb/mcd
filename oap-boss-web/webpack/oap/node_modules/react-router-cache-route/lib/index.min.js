!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("mini-create-react-context"),require("prop-types"),require("react-router-dom")):"function"==typeof define&&define.amd?define(["exports","react","mini-create-react-context","prop-types","react-router-dom"],t):t(e.CacheRoute={},e.React,e.createContext,e.PropTypes,e.reactRouterDom)}(this,function(e,g,t,r,i){"use strict";function o(e){return void 0===e}function u(e){return null===e}function C(e){return"number"==typeof e&&!D(e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var O="default"in g?g.default:g,a=(t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,function(e){return"function"==typeof e}),z=function(e){return"string"==typeof e},n=function(e){return!(o(e)||u(e))},q=function(e){return e instanceof Array},D=function(e){return e!=e},s=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2];try{C(t)&&(t=String(t));var n=(z(t)?t.split("."):t).reduce(function(e,t){return e[t]},e);return o(n)?r:n}catch(e){return r}},j=function(e){for(var t=arguments.length,r=Array(2<t?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];var o=z(o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[])?o.split("."):o,c=s(e,o),e=s(e,o.slice(0,-1));return a(c)?c.call.apply(c,[e].concat(r)):c},F=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.reduce(function(e,t){return o(e)?j(t):j(e)},void 0)},K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(e,t,r){return t&&U(e.prototype,t),r&&U(e,r),e};function U(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function B(e,t){var r,n={};for(r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n}function p(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function H(e){return e.reduce(function(e,t){return[].concat(d(e),d(q(t)?H(t):[t]))},[])}function W(e){var t,r=[];for(t in e)r.push(e[t]);return r}var E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,n=arguments[t];for(r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},P=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var r=t,n=[],o=!0,t=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(o=(a=i.next()).done)&&(n.push(a.value),!r||n.length!==r);o=!0);}catch(e){t=!0,c=e}finally{try{!o&&i.return&&i.return()}finally{if(t)throw c}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")},d=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},V=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),m="object"===("undefined"==typeof global?"undefined":K(global))&&global&&global.Math===Math&&global.Array===Array?global:V,I=s(m,"document.body"),X=s(m,"document.scrollingElement",s(m,"document.documentElement",{}));function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return!!n(e)&&(e.scrollWidth>e.clientWidth||e.scrollHeight>e.clientHeight)}function J(e){return a(s(m,"document.getElementById"))?[].concat(d(F(j(e,"querySelectorAll","*"),[])),[e]).filter(G):[]}function y(){return Object.entries(_).filter(function(e){e=P(e,2)[1];return e instanceof S?e.state.cached:Object.values(e).some(function(e){return e.state.cached})})}function Q(){return E({},_)}function v(e,t){_[e]=t}function Y(e){delete _[e]}function Z(e){return j(e,"reset")}function $(e){(e=s(_,[e]))&&(e instanceof S?Z(e):Object.values(e).forEach(Z))}function ee(e){return j(e,"refresh")}var _={},b=t(),te=b.Provider;b.Consumer;function re(t,e){var r,n;a(g.useContext)&&((r=g.useRef(function(){return null})).current=e,n=g.useContext(b),g.useEffect(function(){var e=j(n,"on",t,function(){j(r.current)});return function(){return j(e)}},[]))}function w(e,t){var r=e.match,n=void 0===(n=e.when)?"forward":n;if(R(r)||(r=null),!t.cached&&r)return{cached:!0,matched:!0};if(t.matched&&!r){var o=s(e,"history.action"),c=!1;if(a(n))c=!n(e);else switch(n){case"always":break;case"back":["PUSH","REPLACE"].includes(o)&&(c=!0);break;default:"POP"===o&&(c=!0)}if(c)return{cached:!1,matched:!1}}return{matched:!!r}}var K=re.bind(null,"didCache"),V=re.bind(null,"didRecover"),ne=n(O.forwardRef),oe="__isComputedUnmatch",R=function(e){return n(e)&&!0!==s(e,oe)},S=(t=g.Component,f(T,t),c(T,[{key:"componentDidUpdate",value:function(e,t){if(t.cached&&this.state.cached)return!0===t.matched&&!1===this.state.matched?(this.props.unmount&&this.ejectDOM(),this.__cacheUpdateTime=Date.now(),W(this.cacheLifecycles.__didCacheListener).forEach(function(e){j(e)}),j(this,"cacheLifecycles.__listener.didCache")):!1===t.matched&&!0===this.state.matched?(this.props.saveScrollPosition&&j(this.__revertScrollPos),this.__cacheUpdateTime=Date.now(),W(this.cacheLifecycles.__didRecoverListener).forEach(function(e){j(e)}),j(this,"cacheLifecycles.__listener.didRecover")):void 0}},{key:"shouldComponentUpdate",value:function(e,t){var r,n=!1===this.state.matched&&!0===t.matched,o=!0===this.state.cached&&!1===t.cached,t=this.state.matched||t.matched||this.state.cached!==t.cached;return t&&((this.props.unmount&&o||n)&&this.injectDOM(),o||n||!this.props.saveScrollPosition||(this.__revertScrollPos=(o=this.props.unmount?this.wrapper:void 0,r=[].concat(d(new Set([].concat(d(H((q(o)?o:[o]).map(J))),d([X,I].filter(G)))))).map(function(e){return[e,{x:e.scrollLeft,y:e.scrollTop}]}),function(){r.forEach(function(e){var e=P(e,2),t=e[0],e=e[1],r=e.x,e=e.y;t.scrollLeft=r,t.scrollTop=e})}))),t}},{key:"componentWillUnmount",value:function(){var e=this.props,t=e.unmount,r=e.href,e=e.multiple,n=j(this.props,"cacheKey",this.props);e?(delete(e=E({},Q()[n]))[r],0===Object.keys(e).length?Y(n):v(n,e)):Y(n),t&&this.injectDOM()}},{key:"render",value:function(){var t=this,e=this.state,r=e.matched,n=e.cached,e=e.key,o=this.props,c=o.className,c=void 0===c?"":c,a=o.behavior,o=o.children,a=F(j(a,void 0,!r),{}),r=a.className,r=void 0===r?"":r,a=B(a,["className"]),c=j(c+" "+r,"trim");return n?O.createElement("div",E({key:e,className:""!==c?c:void 0},a,{ref:function(e){t.wrapper=e}}),O.createElement(te,{value:this.cacheLifecycles},j(o,void 0,this.cacheLifecycles))):null}}]),T);function T(e){l(this,T);for(var t=arguments.length,r=Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];var o,c,a=p(this,(o=T.__proto__||Object.getPrototypeOf(T)).call.apply(o,[this,e].concat(r)));return a.cacheLifecycles={__listener:{},__didCacheListener:{},__didRecoverListener:{},on:function(e,t){var r=Math.random(),n="__"+e+"Listener";return a.cacheLifecycles[n][r]=t,function(){delete a.cacheLifecycles[n][r]}},didCache:function(e){a.cacheLifecycles.__listener.didCache=e},didRecover:function(e){a.cacheLifecycles.__listener.didRecover=e}},a.componentWillReceiveProps=ne?void 0:function(e){e=w(e,a.state);a.setState(e)},a.injectDOM=function(){try{j(a.__parentNode,"insertBefore",a.wrapper,a.__placeholderNode),j(a.__parentNode,"removeChild",a.__placeholderNode)}catch(e){}},a.ejectDOM=function(){try{var e=s(a.wrapper,"parentNode");a.__parentNode=e,j(a.__parentNode,"insertBefore",a.__placeholderNode,a.wrapper),j(a.__parentNode,"removeChild",a.wrapper)}catch(e){}},a.reset=function(){delete a.__revertScrollPos,a.setState({cached:!1})},a.refresh=function(){delete a.__revertScrollPos,a.setState({key:Math.random()})},a.__cacheCreateTime=Date.now(),a.__cacheUpdateTime=a.__cacheCreateTime,e.cacheKey&&(o=j(e.cacheKey,void 0,e),e.multiple?(c=e.href,v(o,E({},Q()[o],h({},c,a)))):v(o,a)),"undefined"!=typeof document&&(c=j(e.cacheKey,void 0,e),a.__placeholderNode=document.createComment(" Route cached "+(c?'with cacheKey: "'+c+'" ':""))),a.state=w(e,{cached:!1,matched:!1,key:Math.random()}),a}S.__name="CacheComponent",S.propsTypes={history:r.object.isRequired,match:r.object.isRequired,children:r.func.isRequired,className:r.string,when:r.oneOfType([r.func,r.oneOf(["forward","back","always"])]),behavior:r.func,unmount:r.bool,saveScrollPosition:r.bool},S.defaultProps={when:"forward",unmount:!1,saveScrollPosition:!1,behavior:function(e){return e?{style:{display:"none"}}:void 0}},S.getDerivedStateFromProps=ne?w:void 0;var ce=!(a(g.lazy)&&!o(g.Suspense)),ae=(t=g.Component,f(L,t),c(L,[{key:"render",value:function(){var e=this.props,t=e.freeze,e=e.children,r=this.promiseCache;if(t&&!r.promise)throw r.promise=new Promise(function(e){r.resolve=e}),r.promise;if(t)throw r.promise;return r.promise&&(r.resolve(),r.promise=void 0),O.createElement(g.Fragment,null,e)}}]),L);function L(){var e;l(this,L);for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(e=p(this,(e=L.__proto__||Object.getPrototypeOf(L)).call.apply(e,[this].concat(r)))).promiseCache={},p(e,e)}var ie=!!g.Suspense?function(e){var t=e.freeze,r=e.children,e=e.placeholder;return ce?r:O.createElement(g.Suspense,{fallback:void 0===e?null:e},O.createElement(ae,{freeze:t},r))}:function(e){return e.children},ue=(t=g.Component,f(k,t),k);function k(e){l(this,k);var r=p(this,(k.__proto__||Object.getPrototypeOf(k)).call(this,e));return r.state={freeze:!1},r.freezeTimeout=null,r.shouldComponentUpdate=function(e){var t=e.freeze,e=r.props.freeze;return t!==e&&(clearTimeout(r.freezeTimeout),r.freezeTimeout=setTimeout(function(){r.setState({freeze:t})},1e3)),!0},r.render=function(){return O.createElement(ie,{freeze:!!r.props.freeze&&r.state.freeze},j(r.props,"children"))},r.state={freeze:e.freeze},r}ue.propsTypes={freeze:r.bool.isRequired};t=g.Component,f(A,t);var le=A;function A(){var e,t;l(this,A);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t=p(this,(e=A.__proto__||Object.getPrototypeOf(A)).call.apply(e,[this].concat(n)))).render=function(){return j(t.props,"children")},t.shouldComponentUpdate=function(e){return e.when},p(t,e)}le.propsTypes={when:r.bool.isRequired};function se(e){return O.createElement(ue,{freeze:!e.when},O.createElement(le,e))}var he=n(g.Fragment),t=(t=g.Component,f(M,t),c(M,[{key:"render",value:function(){var e,s=this,t=this.props,h=t.children,f=t.render,p=t.component,d=t.className,m=t.when,y=t.behavior,v=t.cacheKey,_=t.unmount,b=t.saveScrollPosition,r=t.computedMatchForCacheRoute,w=t.multiple,t=B(t,["children","render","component","className","when","behavior","cacheKey","unmount","saveScrollPosition","computedMatchForCacheRoute","multiple"]);return!O.isValidElement(h)&&(e=h,0===O.Children.count(e))||(f=function(){return h}),r&&(t.computedMatch=r),C(w=w&&!he?!1:w)&&(w=function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;return e<t?t:r<e?r:e}(w,1)),O.createElement(i.Route,t,function(o){function e(t){return O.createElement(S,t,function(e){return O.createElement(se,{when:R(t.match)},function(){return Object.assign(t,{cacheLifecycles:e}),p?O.createElement(p,t):j(f||h,void 0,t)})})}var c=o.match,a=o.computedMatch,t=o.location,r=R(o.match),i=t.pathname,u=t.search,n=C(w)?w:1/0,l={when:m,className:d,behavior:y,cacheKey:v,unmount:_,saveScrollPosition:b};return w&&r&&(s.cache[t=i+u]={updateTime:Date.now(),href:t,pathname:i,render:e},Object.entries(s.cache).sort(function(e,t){e=P(e,2)[1];return P(t,2)[1].updateTime-e.updateTime}).forEach(function(e,t){e=P(e,1)[0];n<=t&&delete s.cache[e]})),w?O.createElement(g.Fragment,null,Object.entries(s.cache).map(function(e){var e=P(e,2),t=e[0],e=e[1],r=e.render,n=e.href,e=e.pathname;return O.createElement(g.Fragment,{key:t},r(E({},o,l,{cacheKey:v,pathname:e,href:n,multiple:!0,key:t,match:t===i+u?c||a:null})))})):e(E({},o,l,{pathname:i,href:i,multiple:!1}))})}}]),M);function M(){var e;l(this,M);for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(e=p(this,(e=M.__proto__||Object.getPrototypeOf(M)).call.apply(e,[this].concat(r)))).cache={},p(e,e)}t.__name="CacheRoute",t.propTypes={component:r.elementType||r.any,render:r.func,children:r.oneOfType([r.func,r.node]),computedMatchForCacheRoute:r.object,multiple:r.oneOfType([r.bool,r.number])},t.defaultProps={multiple:!1};var fe=n(g.Fragment)?function(e){e=e.children;return O.createElement(g.Fragment,null,e)}:n(g.PropTypes)?function(e){e=e.children;return O.createElement("div",null,e)}:function(e){return e.children},pe=(fe.displayName="SwitchFragment",n(i.__RouterContext)||n(i.useHistory)),N=(N=i.Switch,f(x,N),c(x,[{key:"render",value:function(){var e=this.props,t=e.children,n=e.which,e=this.getContext(),o=e.location,c=e.match,a=!1;return O.createElement(se,{when:R(c)},function(){return O.createElement(fe,null,O.Children.map(t,function(e){if(!O.isValidElement(e))return null;var t=e.props.path||e.props.from,t=a?null:t?i.matchPath(o.pathname,E({},e.props,{path:t}),c):c,r=void 0,r=n(e)?O.cloneElement(e,E({location:o,computedMatch:t},u(t)?{computedMatchForCacheRoute:h({},oe,!0)}:null)):t&&!a?O.cloneElement(e,{location:o,computedMatch:t}):null;return a=a||!!t,r}))})}}]),x);function x(){var e,t;l(this,x);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=p(this,(e=x.__proto__||Object.getPrototypeOf(x)).call.apply(e,[this].concat(n)))).getContext=function(){var e;return pe?{location:(e=t.props).location,match:e.match}:(e=t.context.router.route,{location:t.props.location||e.location,match:e.match})},p(t,t)}pe?(N.propTypes={children:r.node,location:r.object.isRequired,match:r.object.isRequired,which:r.func},N=i.withRouter(N)):(N.contextTypes={router:r.shape({route:r.object.isRequired}).isRequired},N.propTypes={children:r.node,location:r.object,which:r.func}),N.defaultProps={which:function(e){return"CacheRoute"===s(e,"type.__name")}};c=N;e.default=t,e.CacheRoute=t,e.CacheSwitch=c,e.dropByCacheKey=$,e.refreshByCacheKey=function(e){e=s(_,[e]);e&&(e instanceof S?ee(e):Object.values(e).forEach(ee))},e.getCachingKeys=function(){return y().map(function(e){return P(e,1)[0]})},e.clearCache=function(){y().forEach(function(e){e=P(e,1)[0];return $(e)})},e.getCachingComponents=function(){return y().reduce(function(e,t){var t=P(t,2),n=t[0],t=t[1];return E({},e,t instanceof S?h({},n,t):Object.entries(t).reduce(function(e,t){var t=P(t,2),r=t[0],t=t[1];return E({},e,h({},n+"."+r,t))},{}))},{})},e.useDidCache=K,e.useDidRecover=V,Object.defineProperty(e,"__esModule",{value:!0})});
